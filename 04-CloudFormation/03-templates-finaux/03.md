# **Template S3 simple ‚Äî `S3.yaml`**

> Objectif : Cr√©er un bucket S3 pour un site statique.


```yaml
AWSTemplateFormatVersion: "2010-09-09"
Description: "cafe S3 template"

Resources:
  S3Bucket:
    Type: AWS::S3::Bucket
    Properties:
      WebsiteConfiguration:
        IndexDocument: index.html
        ErrorDocument: error.html
    DeletionPolicy: Retain

Outputs:
  WebsiteURL:
    Value: !GetAtt S3Bucket.WebsiteURL
    Description: URL of the static website
```

![image](https://github.com/user-attachments/assets/6f6ee5a0-f0fa-4037-acdf-e2dad994f643)


```
aws configure get region
aws cloudformation create-stack --stack-name CreateBucket --template-body file://S3.yaml
```


![image](https://github.com/user-attachments/assets/decb3264-d5aa-4c40-96aa-ce7601d0f02a)




```
#1. Download the website files
wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/static-website.zip
unzip static-website.zip -d static
cd static
#2. Set the ownership controls on the bucket
aws s3api put-bucket-ownership-controls --bucket <BUCKET-NAME> --ownership-controls Rules=[{ObjectOwnership=BucketOwnerPreferred}]
#3. Set the public access block settings on the bucket
aws s3api put-public-access-block --bucket <BUCKET-NAME> --public-access-block-configuration "BlockPublicAcls=false,RestrictPublicBuckets=false,IgnorePublicAcls=false,BlockPublicPolicy=false"
#4. Copy the website files to the bucket
aws s3 cp --recursive . s3://<BUCKET-NAME>/ --acl public-read
cd ../
aws cloudformation validate-template --template-body file://S3.yaml
aws cloudformation update-stack --stack-name CreateBucket --template-body file://S3.yaml
```


##### Nom : createbucket-s3bucket-kyybdlj5vchi 




```
aws configure get region
aws cloudformation create-stack --stack-name CreateBucket --template-body file://S3.yaml
#1. Download the website files
wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/static-website.zip
unzip static-website.zip -d static
cd static
#2. Set the ownership controls on the bucket
aws s3api put-bucket-ownership-controls --bucket <BUCKET-NAME> --ownership-controls Rules=[{ObjectOwnership=BucketOwnerPreferred}]
#3. Set the public access block settings on the bucket
aws s3api put-public-access-block --bucket <BUCKET-NAME> --public-access-block-configuration "BlockPublicAcls=false,RestrictPublicBuckets=false,IgnorePublicAcls=false,BlockPublicPolicy=false"
#4. Copy the website files to the bucket
aws s3 cp --recursive . s3://<BUCKET-NAME>/ --acl public-read
cd ../
aws cloudformation validate-template --template-body file://S3.yaml
aws cloudformation update-stack --stack-name CreateBucket --template-body file://S3.yaml
git clone <url>
cd CFTemplatesRepo
git status
git add templates/cafe-network.yaml
git commit -m 'initial commit of network template' templates/cafe-network.yaml
git status
git push
--------------
UPDATE
--------------
Outputs:
  PublicSubnet:
    Description: The subnet ID to use for public web servers
    Value:
      Ref: PublicSubnet
    Export:
      Name:
        'Fn::Sub': '${AWS::StackName}-SubnetID'
  VpcId:
    Description: The VPC ID
    Value:
      Ref: VPC
    Export:
      Name:
        'Fn::Sub': '${AWS::StackName}-VpcID'
		
--------------------------
	
# KeyName: !FindInMap [RegionMap, !Ref "AWS::Region", keypair]


NetworkInterfaces:
  - DeviceIndex: '0'
    AssociatePublicIpAddress: 'true'
    SubnetId: !ImportValue
      'Fn::Sub': '${CafeNetworkParameter}-SubnetID'
    GroupSet:
      - !Ref CafeSG


Properties
  UserData:
    Fn::Base64:
      !Sub |
        #!/bin/bash
        yum -y update
        yum install -y httpd mariadb-server wget
        amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2
        systemctl enable httpd
        systemctl start httpd
        systemctl enable mariadb
        systemctl start mariadb
        wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/cafe-app.sh
        chmod +x cafe-app.sh
        ./cafe-app.sh
		
----------------

aws cloudformation validate-template --template-body file:///home/ec2-user/environment/CFTemplatesRepo/templates/cafe-app.yaml
aws cloudformation create-stack --stack-name update-cafe-network --template-body file:///home/ec2-user/environment/CFTemplatesRepo/templates/cafe-network.yaml --region us-west-2
aws s3 cp templates/cafe-app.yaml s3://<repobucket-bucketname>/
```








# `lab-network.yaml`

> D√©ploie le VPC et le sous-r√©seau public avec sorties exportables.

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: VPC et sous-r√©seau public pour l'application inventory

Resources:
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 10.0.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: lab-vpc

  PublicSubnet:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.1.0/24
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select [ 0, !GetAZs '' ]
      Tags:
        - Key: Name
          Value: lab-public-subnet

Outputs:
  VPC:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub "${AWS::StackName}-VPCID"

  PublicSubnet:
    Description: Public subnet ID
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub "${AWS::StackName}-SubnetID"
```

<br/>

# `lab-application.yaml`

> D√©ploie une instance EC2 + groupe de s√©curit√© avec HTTP uniquement.

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Application web d√©ploy√©e dans le VPC existant

Parameters:
  NetworkStackName:
    Type: String
    Description: Nom de la pile r√©seau d√©ploy√©e

Resources:
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTP ingress
      VpcId:
        Fn::ImportValue: !Sub "${NetworkStackName}-VPCID"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0c02fb55956c7d316  # Exemple Amazon Linux 2 us-east-1
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId:
            Fn::ImportValue: !Sub "${NetworkStackName}-SubnetID"
          GroupSet:
            - !Ref WebServerSecurityGroup
      Tags:
        - Key: Name
          Value: WebServer

Outputs:
  WebServerPublicIP:
    Description: Adresse IP publique du serveur web
    Value: !GetAtt WebServerInstance.PublicIp
```

<br/>

# `lab-application2.yaml`

> Version mise √† jour : autorise aussi le port SSH (22)

```yaml
AWSTemplateFormatVersion: '2010-09-09'
Description: Application web avec acc√®s SSH

Parameters:
  NetworkStackName:
    Type: String
    Description: Nom de la pile r√©seau d√©ploy√©e

Resources:
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTP and SSH ingress
      VpcId:
        Fn::ImportValue: !Sub "${NetworkStackName}-VPCID"
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0

  WebServerInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t2.micro
      ImageId: ami-0c02fb55956c7d316
      NetworkInterfaces:
        - AssociatePublicIpAddress: true
          DeviceIndex: 0
          SubnetId:
            Fn::ImportValue: !Sub "${NetworkStackName}-SubnetID"
          GroupSet:
            - !Ref WebServerSecurityGroup
      Tags:
        - Key: Name
          Value: WebServer

Outputs:
  WebServerPublicIP:
    Description: Adresse IP publique du serveur web
    Value: !GetAtt WebServerInstance.PublicIp
```

<br/>

# (Bonus) Ajout dans `lab-application2.yaml` : Volume EBS avec snapshot √† la suppression

> Ajouter ce bloc √† la fin de `Resources` pour la **T√¢che 5**

```yaml
  DiskVolume:
    Type: AWS::EC2::Volume
    Properties:
      Size: 100
      AvailabilityZone: !GetAtt WebServerInstance.AvailabilityZone
      Tags:
        - Key: Name
          Value: Web Data
    DeletionPolicy: Snapshot
```

<br/>


# Annexe 1



## üü© **Initialisation et premi√®re pile CloudFormation (S3)**

```bash
# Obtenir la r√©gion par d√©faut
aws configure get region

# Cr√©er la pile avec le template S3 simple
aws cloudformation create-stack --stack-name CreateBucket --template-body file://S3.yaml
```



## üü© **T√©l√©charger et d√©ployer le site statique**

```bash
# 1. T√©l√©charger les fichiers du site
wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/static-website.zip
unzip static-website.zip -d static
cd static

# 2. D√©finir les r√®gles de propri√©t√©
aws s3api put-bucket-ownership-controls \
  --bucket <BUCKET-NAME> \
  --ownership-controls Rules=[{ObjectOwnership=BucketOwnerPreferred}]

# 3. Autoriser l‚Äôacc√®s public
aws s3api put-public-access-block \
  --bucket <BUCKET-NAME> \
  --public-access-block-configuration "BlockPublicAcls=false,RestrictPublicBuckets=false,IgnorePublicAcls=false,BlockPublicPolicy=false"

# 4. Uploader les fichiers
aws s3 cp --recursive . s3://<BUCKET-NAME>/ --acl public-read

# Revenir au dossier parent
cd ..
```



## üü© **Valider et mettre √† jour le template S3**

```bash
# Valider la syntaxe YAML
aws cloudformation validate-template --template-body file://S3.yaml

# Mettre √† jour la pile S3 pour activer le site statique
aws cloudformation update-stack --stack-name CreateBucket --template-body file://S3.yaml
```



## üü© **Travailler avec Git et CodeCommit**

```bash
# Cloner le d√©p√¥t CodeCommit
git clone <url>

# Aller dans le d√©p√¥t
cd CFTemplatesRepo
git status

# Ajouter et committer le fichier de r√©seau
git add templates/cafe-network.yaml
git commit -m 'initial commit of network template' templates/cafe-network.yaml
git status
git push
```



## üü© **Mise √† jour du r√©seau avec des exports CloudFormation**

```yaml
# √Ä ajouter √† la fin de cafe-network.yaml

Outputs:
  PublicSubnet:
    Description: The subnet ID to use for public web servers
    Value: !Ref PublicSubnet
    Export:
      Name: !Sub '${AWS::StackName}-SubnetID'

  VpcId:
    Description: The VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-VpcID'
```



## üü© **D√©finir l‚Äôinstance EC2 dans cafe-app.yaml**

```yaml
KeyName: !FindInMap [RegionMap, !Ref "AWS::Region", keypair]

NetworkInterfaces:
  - DeviceIndex: '0'
    AssociatePublicIpAddress: 'true'
    SubnetId: !ImportValue
      'Fn::Sub': '${CafeNetworkParameter}-SubnetID'
    GroupSet:
      - !Ref CafeSG

UserData:
  Fn::Base64:
    !Sub |
      #!/bin/bash
      yum -y update
      yum install -y httpd mariadb-server wget
      amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2
      systemctl enable httpd
      systemctl start httpd
      systemctl enable mariadb
      systemctl start mariadb
      wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/cafe-app.sh
      chmod +x cafe-app.sh
      ./cafe-app.sh
```



## üü© **Valider le template application**

```bash
aws cloudformation validate-template \
  --template-body file:///home/ec2-user/environment/CFTemplatesRepo/templates/cafe-app.yaml
```



## üü© **Cr√©er la pile r√©seau dans une autre r√©gion**

```bash
aws cloudformation create-stack \
  --stack-name update-cafe-network \
  --template-body file:///home/ec2-user/environment/CFTemplatesRepo/templates/cafe-network.yaml \
  --region us-west-2
```



## üü© **Uploader le template app dans un bucket S3**

```bash
aws s3 cp templates/cafe-app.yaml s3://<repobucket-bucketname>/
```


# Annexe 2



```bash
aws configure get region

aws cloudformation create-stack --stack-name CreateBucket --template-body file://S3.yaml




#1. Download the website files

wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/static-website.zip

unzip static-website.zip -d static

cd static

#2. Set the ownership controls on the bucket

aws s3api put-bucket-ownership-controls --bucket <BUCKET-NAME> --ownership-controls Rules=[{ObjectOwnership=BucketOwnerPreferred}]

#3. Set the public access block settings on the bucket

aws s3api put-public-access-block --bucket <BUCKET-NAME> --public-access-block-configuration "BlockPublicAcls=false,RestrictPublicBuckets=false,IgnorePublicAcls=false,BlockPublicPolicy=false"

#4. Copy the website files to the bucket

aws s3 cp --recursive . s3://<BUCKET-NAME>/ --acl public-read



cd ../

aws cloudformation validate-template --template-body file://S3.yaml


aws cloudformation update-stack --stack-name CreateBucket --template-body file://S3.yaml


git clone <url>


cd CFTemplatesRepo

git status

git add templates/cafe-network.yaml

git commit -m 'initial commit of network template' templates/cafe-network.yaml


git status

git push


--------------
UPDATE
--------------

Outputs:
  PublicSubnet:
    Description: The subnet ID to use for public web servers
    Value:
      Ref: PublicSubnet
    Export:
      Name:
        'Fn::Sub': '${AWS::StackName}-SubnetID'
  VpcId:
    Description: The VPC ID
    Value:
      Ref: VPC
    Export:
      Name:
        'Fn::Sub': '${AWS::StackName}-VpcID'
		
		

KeyName: !FindInMap [RegionMap, !Ref "AWS::Region", keypair]


NetworkInterfaces:
  - DeviceIndex: '0'
    AssociatePublicIpAddress: 'true'
    SubnetId: !ImportValue
      'Fn::Sub': '${CafeNetworkParameter}-SubnetID'
    GroupSet:
      - !Ref CafeSG


Properties
  UserData:
    Fn::Base64:
      !Sub |
        #!/bin/bash
        yum -y update
        yum install -y httpd mariadb-server wget
        amazon-linux-extras install -y lamp-mariadb10.2-php7.2 php7.2
        systemctl enable httpd
        systemctl start httpd
        systemctl enable mariadb
        systemctl start mariadb
        wget https://aws-tc-largeobjects.s3.us-west-2.amazonaws.com/CUR-TF-200-ACACAD-2-91555/14-lab-mod10-challenge-CFn/s3/cafe-app.sh
        chmod +x cafe-app.sh
        ./cafe-app.sh
		

aws cloudformation validate-template --template-body file:///home/ec2-user/environment/CFTemplatesRepo/templates/cafe-app.yaml


aws cloudformation create-stack --stack-name update-cafe-network --template-body file:///home/ec2-user/environment/CFTemplatesRepo/templates/cafe-network.yaml --region us-west-2


aws s3 cp templates/cafe-app.yaml s3://<repobucket-bucketname>/
```
